# -*- mode: ruby -*-
# vi: set ft=ruby :

# Configuration variables
SERVER_NAME = "sabelS"
WORKER_NAME = "sabelSW"
SERVER_IP = "192.168.56.110"
WORKER_IP = "192.168.56.111"

Vagrant.configure("2") do |config|
  # Use latest stable Ubuntu
  config.vm.box = "ubuntu/jammy64"
  
  # Disable automatic box update checking
  config.vm.box_check_update = false

  # Server (Controller) Machine
  config.vm.define SERVER_NAME do |server|
    server.vm.hostname = SERVER_NAME
    server.vm.network "private_network", ip: SERVER_IP
    server.vm.provider "virtualbox" do |vb|
      vb.name = SERVER_NAME
      vb.memory = 1024
      vb.cpus = 1
    end
    

    # Provisioning script for K3s server
    server.vm.provision "shell", inline: <<-SHELL
      # Update system
      apt-get update
      
      # Install K3s in server mode
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 644 --tls-san #{SERVER_IP} --node-ip #{SERVER_IP} --bind-address #{SERVER_IP}" sh -
      
      # Wait for K3s to be ready
      sleep 10
      
      # Copy kubeconfig for vagrant user
      mkdir -p /home/vagrant/.kube
      cp /etc/rancher/k3s/k3s.yaml /home/vagrant/.kube/config
      chown vagrant:vagrant /home/vagrant/.kube/config
      chmod 600 /home/vagrant/.kube/config
      
      # Get node token for worker
      cp /var/lib/rancher/k3s/server/node-token /vagrant/
      
      echo "K3s server installed successfully!"
      echo "Node token copied to /vagrant/node-token"
    SHELL
  end

#   # Worker (Agent) Machine  
#   config.vm.define WORKER_NAME do |worker|
#     worker.vm.hostname = WORKER_NAME
#     worker.vm.network "private_network", ip: WORKER_IP
    
#     worker.vm.provider "virtualbox" do |vb|
#       vb.name = WORKER_NAME
#       vb.memory = 1024
#       vb.cpus = 1
#     end

#     # Provisioning script for K3s agent
#     worker.vm.provision "shell", inline: <<-SHELL
#       # Update system
#       apt-get update
      
#       # Wait for server to be ready and token to be available
#       while [ ! -f /vagrant/node-token ]; do
#         echo "Waiting for server node token..."
#         sleep 5
#       done
      
#       # Install K3s in agent mode
#       curl -sfL https://get.k3s.io | K3S_URL="https://#{SERVER_IP}:6443" K3S_TOKEN="$(cat /vagrant/node-token)" INSTALL_K3S_EXEC="--node-ip #{WORKER_IP}" sh -
      
#       echo "K3s agent installed successfully!"
#     SHELL
#   end

  # SSH configuration - passwordless access
  config.ssh.insert_key = false
  config.ssh.private_key_path = ["~/.vagrant.d/insecure_private_key", "~/.ssh/id_rsa"]
  config.vm.provision "shell", inline: <<-SHELL
    # Configure SSH for passwordless access
    sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/g' /etc/ssh/sshd_config
    systemctl restart sshd
  SHELL

end